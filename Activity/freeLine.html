<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title id="myTitle">飞扬旅游网</title>
    <meta name="keywords" content="宁波飞扬旅行社,宁波旅行社,宁波旅游网" id="myKeywords" />
    <meta name="description" id="myDescription" content="飞扬旅游网隶属于浙江飞扬国际旅游集团,宁波旅行社行业第一,全国第八,浙江省首批五星级旅行社,宁波市最佳旅行社.服务热线:4000-365-666" />
    <meta name="apple-mobile-web-app-title" content="飞扬旅游网" />
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/my-app.css">
    <link rel="stylesheet" href="/css/jin.css">
</head>
<body ontouchstart>
    <div class="views" id="loadDiv">
        <!--view-main start-->
        <div class="view view-main">
            <!--page start-->
            <div class="page">
                <!--page-content start-->
                <div class="page-content white">
                    <div class="loadingRow" style="background:#66cbff"><img style="margin-top:-20%;" src="/images/loading-ani.gif" alt=""></div>
                </div>
                <!--page-content END-->
            </div>
            <!-- page END-->

        </div>
        <!--view-main END-->
    </div>
    <!--views start-->
    <div class="views" id="contentDiv" style="display:none;">
        <!--view-main start-->
        <div class="view view-main">
            <!--page start-->
            <div class="page">
                <!--page-content start-->
                <div class="page-content grayBg">
                    <div class="w-panel borderNone" style="padding-top:0;">
                        <div class="media-panel activeD">
                            <div class="swiper-custom mb15">
                                <div class="swiper-container">
                                    <div class="swiper-pagination"></div>
                                    <div id="picList" class="swiper-wrapper" style="max-height:250px;">

                                    </div>
                                </div>
                            </div>
                            <a href="javascript:history.back();" class="floating-button fixB l">
                                <i class="icon icon-back mBack"></i>
                            </a>
                        <!--<a href="#" class="floating-button shareBtn"><i class="icon icon-back share"></i></a>-->
                         </div>
                        <div class="plr10 ft14">
                            <div class="ft14 color6 mb10" id="LineNO" style="display:none"></div>
                            <div class="ft18 mb10" id="lineTitle"></div>
                            <div class="color9 ft12 mb5" id="subTitle"></div>
                            <div class="red_t ft14 mb5">¥ <font class="ft24" id="linePrice"></font>起
                                <div style="border:1px solid #f60; border-radius:5px; padding:0 5px; line-height:20px; display:inline-block; margin-left:15px;" id="prePriceStr"></div>
                            </div>
                            <div class="row linkRow" style="border-top:1px solid #efefef; padding-top:10px">
                            <a href="javascript:void(0);" id="startPlc"></a>
                            <a href="javascript:void(0);" id="trafficStr"></a>
                            <a href="javascript:void(0);" id="dayStr"></a>
                            </div>
                        </div>
                    </div>

                    <div id="moreDiv" class="list-block media-list mt" style="margin-top:15px;margin-bottom:15px;">
                        <ul>
                            <li>
                                <div class="swipeout-content">
                                    <a class="item-link item-content" href="#" id="moreinfoLink">
                                        <div class="item-inner">
                                            <div class="item-title-row">
                                                <div class="item-title"><i class="i i0"></i><font class="pinkTxt" id="scoreStr"></font>满意度，<font class="pinkTxt" id="dpNum"></font>用户点评</div>
                                            </div>
                                            <div class="color6 tt">30天内已有<font class="pinkTxt" id="playNum"></font>人游玩过！此线共有<font class="pinkTxt" id="BrowseCount"></font>人浏览过</div>
                                        </div>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="w-panel borderNone plr10" id="trafficPlanStr">
                        <div class="row"><span class="ft16"><i class="iconC">&nbsp;</i>交通信息</span></div>
                        
                    </div>
                    <div class="w-panel borderNone plr10" id="hotelPlanStr">
                        <div class="mb10"><span class="ft16"><i class="iconC hotel">&nbsp;</i>酒店信息</span></div>
                        
                        
                    </div>

                    <div class="w-panel borderNone plr10">
                        <h3 class="normal ft16 mb15">出发日期<font style="font-size:10px;color:#999;">(以下价格均为起价)</font></h3>
                        <div class="date-panel row alginCenter">
                            <ul class="date-list" id="dateStr"></ul>
                            <a class="next-date" href="javascript:goOrder();"><i class="icon icon-next"></i></a>
                        </div>

                    </div>

                    <div class="w-panel tab-list borderNone p0">
                        <!-- tabs控制面板 -->
                        <div class="buttons-row"> <a class="tab-link button active" href="#tab1">行程特色</a> <a class="tab-link button" href="#tab2">参考行程</a> <a class="tab-link button" href="#tab3"  id="commStr">用户点评(0)</a> </div>

                            <!-- Tabs, 标签内容区容器 -->
                            <div class="tabs">
                                <!-- Tab 1, 默认激活 -->
                                <div id="tab1" class="tab active">
                                    <div class="content-block">
                                        <div class="p10 ft15 color6 ft14 line25" id="ProductFeatures">
                                            
                                        </div>
                                    </div>
                                </div>
                                <!-- Tab 2 -->
                                <div class="tab" id="tab2">
                                    <div class="content-block p10 color6 ft14" id="tripStr"></div>
                                </div>
                                <!-- Tab 3-->
                                <div class="tab" id="tab3">
                                    <div class="content-block" id="">

                                        <div class="list-block media-list border_b">
                                            <ul class="cmtList" id="commentList"></ul>
                                        </div>

                                        <div class="p10 ft14"><a class="red_t2 link" href="#" id="moreCommnet">点击查看更多</a></div>
                                    </div>
                                </div>
                            </div>

                    </div>
                    <div class="list-block media-list mt" style="margin-bottom:20px;">
                        <ul>
                            <li>
                                <div class="swipeout-content">
                                    <a class="item-link item-content" href="#" id="tripLink">
                                        <div class="item-inner">
                                            <div class="item-title-row">
                                                <div class="item-title"><i class="i i02"></i>推荐攻略</div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </li>
                            <li>
                                <div class="swipeout-content">
                                    <a class="item-link item-content" href="#" id="feeLink">
                                        <div class="item-inner">
                                            <div class="item-title-row">
                                                <div class="item-title"><i class="i i03"></i>费用说明</div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </li>

                            <li>
                                <div class="swipeout-content">
                                    <a href="#" class="item-link item-content" id="desLink">
                                        <div class="item-inner">
                                            <div class="item-title-row">
                                                <div class="item-title"><i class="i i06"></i>目的地信息</div>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="space">&nbsp;</div>
                </div>
                <!--page-content END-->
            </div>
            <!-- page END-->
            <div class="toolbar tabbar yd">
                <!--  groupBar start -->
                <div class="toolbar-inner groupBar">
                    <a class="tab-link m1" href="javascript:telAction();">
                        <i class="icon tel"></i>
                        <span>电话客服</span>
                    </a>
                    <a class="tab-link m2" href="javascript:goIntOrder();" style="display:none;">
                        <i class="icon order"></i>
                        <span>意向下单<font class="ft12 pinkTxt">(无需付款)</font></span>
                    </a>
                    <a class="button button-fill m3" href="javascript:goOrder();">立即预定</a>

                </div>
                <!--  shipBar start -->
            </div>
        </div>
        <!--view-main END-->
    </div>
    <!-- views end-->

    <script type="text/javascript" src="/js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="/js/command.js"></script>
    <script type="text/javascript" src="/js/framework7.js"></script>
    <script type="text/javascript" src="/js/kitchen-sink.js"></script>
    <script type="text/javascript" src="/js/order.js"></script>
    <script type="text/javascript">
        var myRequest = GetRequest();
        var proId = decodeURI(myRequest["id"]);
        var psprice = decodeURI(myRequest["ps"]);
        var ppid = decodeURI(myRequest["ppid"]);
        var vyw = decodeURI(myRequest["yw"]);
        var Concid = decodeURI(myRequest["Concid"]);
        var proTitle = "";
        var desStr = "";
        var proType = 0;
        var proGADDRID = 0;
        $.getJSON(freeInfoUrl + "&ProductID=" + proId, function (data) {
            if (data != null && data.data != null) {
                var item = data.data;
                console.log(item);
                sessionStorage.setItem("freelineJson", JSON.stringify(item));
                $("#LineNO").html("线路编号：" + item.BasicNO);
                $("#lineTitle").html(item.WebTitle);
                sessionStorage.setItem("title", item.WebTitle);
                $("#myTitle").html(item.WebTitle);
                $("#myKeywords").attr("content", item.SubTitle);
                $("#myDescription").attr("content", item.WebTitle + ",飞扬旅游网");

                proType = item.PBASIID;
                proGADDRID = item.GADDRID;
                proTitle = item.WebTitle;
                desStr = item.Destination;
                $("#playNum").html(item.TotalCount);
                $("#BrowseCount").html(item.BrowseCount);
                if (item.Scores == 100 || item.CommentCount == 0) {
                    $("#moreDiv").hide();
                }
                $("#subTitle").html(item.SubTitle);
                $("#linePrice").html(psprice);
                //$("#linePrice").html(item.DefaultPrice);
                var departStr = "无";
                if (item.Depart != "") {
                    departStr = item.Depart;
                }
                $("#prePriceStr").html("活动价");
                //$("#prePriceStr").html("立减" + PreferentialJson.Free + "元/成人");
                $("#startPlc").html("<i class='iconB start'></i>出发地：" + departStr);
                $("#trafficStr").html("<i class='iconB reBack'></i>" + item.Go_Traffic + "&nbsp;往/" + item.Round_Traffic + "&nbsp;返");
                $("#dayStr").html("<i class='iconB delay'></i>" + item.Day + "天" + item.Night + "晚");

                $("#ProductFeatures").html(escape2Html(item.Remarks));
                var tripStr = "";
                if (item.TripInfo != null && item.TripInfo.length > 0) {
                    $.each(item.TripInfo, function (i, tripItem) {
                        var tempStr = tripTrafficStr(tripItem.Title);
                        if (tempStr == "") {
                            tempStr = "无";
                        }
                        tripStr += "<section class='mb10'><div class='ft16'><span class='mr10'>第" + tripItem.Day + "天</span>" + tempStr + "</div></section>";
                    });
                }
                if (tripStr == "") {
                    tripStr = "<section class='mb10'><div class='ft16'><span class='mr10'>无参考行程</div></section>";
                }
                $("#tripStr").html(tripStr);

                var startjttime = "";//控制交通
                var endjttime = "";
                //团期处理
                if (item.DateTime != null && item.DateTime.length > 0) {;
                    var dateStr = "";
                    var index = 1;
                    $.each(item.DateTime, function (i, dateItem) {

                        if (dateItem.PPRODID == ppid) {
                            startjttime = dateItem.StartTime;
                            endjttime = getNewDay(startjttime, item.TripInfo.length - 1);
                            console.log(startjttime +"||"+ endjttime);
                            if (index == 7) {
                                return false;
                            }
                            var tempTime = new Date(dateItem.StartTime);
                            var monthStr = (tempTime.getMonth() + 1);
                            if (tempTime.getMonth() < 9) {
                                monthStr = "0" + (tempTime.getMonth() + 1);
                            }
                            var dayStr = tempTime.getDate();
                            if (tempTime.getDate() < 10) {
                                dayStr = "0" + tempTime.getDate();
                            }
                            var tempStr = monthStr + "-" + dayStr;
                            dateStr += "<li class='col-33' onclick='goOrder2(" + dateItem.PPRODID + ");'><div class='date-time'><span class='mr5'>" + tempStr + "</span>" + getDayOfWeekStr(tempTime.getDay()) + "</div><p class='date-price'>(减)¥ " + psprice + "</p></li>";
                            index++;
                        }

                    });
                    $("#dateStr").html(dateStr);
                }
                //图片处理
                $.each(item.BigPic, function (i, picItem) {
                    $("#picList").append("<div class='swiper-slide'><img src='" + picItem.PicPath + "' alt=''></div>");
                });
                var myApp = new Framework7();
                var mySwiper = myApp.swiper('.swiper-container', {
                    autoplay: 2500,
                    pagination: '.swiper-pagination',
                    paginationHide: false,
                    paginationClickable: true,
                });

                //交通方案
                var traStr = "";
                if (item.TrafficInfo != null && item.TrafficInfo.length > 0) {
                    var trafficItem = item.TrafficInfo[0];
                    if (trafficItem != null) {
                        $.each(trafficItem.Children, function (i, traItem) {
                            var icoStr = "";
                            var vPostponeDay = "";
                            if (traItem.TrifficMode == 0) {
                                icoStr = "go";
                                vPostponeDay=startjttime;
                            }
                            else {
                                icoStr = "back";
                                vPostponeDay = endjttime;
                            }
                            traStr += "<div class='tra_row'><div class='color6 ft14 mb10'><i class='iconC " + icoStr + "'></i><font class='mr10'>" + vPostponeDay + "</font>" + traItem.PBAS1Title + traItem.PPROD1Title + "</div>";
                            traStr += "<div class='row center alginCenter transportation'><div class='traL'><p class='ft14 color6'></p><p class='ft18'>" + traItem.StartTime + "</p>";
                            traStr += "<p class='color9 ft13 elli'>" + traItem.BeginPlace + "</p></div><div class='ft14 color9 traM'><p class='mb15'></p><p></p></div>";
                            traStr += "<div class='traRP'><p class='ft14 color6 traR'></p><p class='ft18'>21:30</p><p class='color9 ft13'>" + traItem.ArrivePlace + "</p></div></div></div>";
                        });                           
                    }                      
                }
                if (traStr == "") {
                    $("#trafficPlanStr").hide();
                }
                else {
                    $("#trafficPlanStr").append(traStr);
                }

                //酒店方案
                var hotelStr = "";
                if (item.HotelInfo != null && item.HotelInfo.length > 0) {
                    var hotelItem = item.HotelInfo[0];
                    if (hotelItem != null) {
                        $.each(hotelItem.Children, function (i, hotItem) {
                            hotelStr += "<div class='list-block media-list noB'><div class='item-content'><div class='item-media'><img width='120' height='80' src='" + hotItem.DefaultPic + "' alt=''></div>";
                            hotelStr += "<div class='item-inner' style='overflow:hidden;'><div class='item-title-row mb5'><div class='item-title'>" + hotItem.PBAS1Title + "</div>";
                            hotelStr += "</div><div class='color6 ft14'>星级：" + hotItem.Grade + "</div><div class='color6 ft14 row-3'>介绍：" + hotItem.Address + "</div></div></div></div>";
                        });
                    }                   
                }
                if (hotelStr == "") {
                    $("#hotelPlanStr").hide();
                }
                else {
                    $("#hotelPlanStr").append(hotelStr);
                    $("#hotelPlanStr").append("<p class='color9'><font class='red_t'>*</font> 具体信息已实际行程确认单为准</p>");
                }


                //获取评论
                $.getJSON(commentsCountUrl + "&ProductID=" + proId, function (data2) {
                    if (data2 != null && data2.data != null) {
                        $("#commStr").html("用户点评(" + data2.data.TotalCount + ")");
                        $("#dpNum").html(data2.data.TotalCount);
                    }

                });
                var commentStr = "";
                $.getJSON(commentsListUrl + "&ProductID=" + proId + "&size=3&page=1", function (data2) {
                    if (data2 != null && data2.data != null) {
                        var myscore = 90;
                        if (data2.data.TotalScores > 90) {
                            myscore = data2.data.TotalScores;
                        }
                        $("#scoreStr").html(myscore + "%");
                        $.each(data2.data.CommentsInfo, function (i, commItem) {
                            commentStr += "<li class='item-content'><div class='item-inner'><div class='item-title-row color9 mb5'><div class='item-title'>" + commItem.FullName + "</div>";
                            commentStr += "<div class='item-after'>满意度：<font class='red_t2'>" + commItem.TotalScores + "%</font></div></div><div class='itemTxt mb5 ft14'>" + commItem.Notes + "</div>";
                            commentStr += "<div class='date-msg'>" + commItem.RvTime + "</div></div></li>";
                        });
                        if (commentStr == "") {
                            commentStr += "<li class='item-content'><div class='item-inner'><div class='item-title-row color9 mb5'><div class='item-title'></div>";
                            commentStr += "<div class='item-after'><font class='red_t2'></font></div></div><div class='itemTxt mb5 ft14'>暂无点评</div>";
                            commentStr += "<div class='date-msg'></div></div></li>";
                        }
                        $("#commentList").html(commentStr);
                    }
                });
                $("#feeLink").attr("href", "javascript:window.location.href='../ProductOther/groupFee.html?id=" + proId + "'");
                $("#noteLink").attr("href", "javascript:window.location.href='../TravelNotes/notesList.html?gaddr=" + item.GADDRID + "'");
                $("#desLink").attr("href", "javascript:window.location.href='../Destination/destinationDetail.html?gaddr=" + item.GADDRID + "'");
                $("#tripLink").attr("href", "javascript:window.location.href='../ProductOther/freeTrip.html?id=" + proId + "'");

                $("#loadDiv").hide();
                $("#contentDiv").show();
            }
        });

        function goOrder() {
            window.location.href = "/Activity/free_step1.html?id=" + proId + "&pprod=" + ppid + "&type=" + proType + "&ps=" + psprice + "&Concid=" + Concid;
        }
        function goOrder2(pprod) {
            window.location.href = "/Activity/free_step1.html?id=" + proId + "&pprod=" + pprod + "&type=" + proType + "&ps=" + psprice + "&Concid=" + Concid;
        }
        function goIntOrder() {
            goIntentionOrder(proTitle, desStr, proId,proType,proGADDRID);
        }
        function telAction() {
            goTel();
        }
        function getNewDay(dateTemp, days) {
            var dateTemp = dateTemp.split("-");
            var nDate = new Date(dateTemp[1] + '-' + dateTemp[2] + '-' + dateTemp[0]); //转换为MM-DD-YYYY格式    
            var millSeconds = Math.abs(nDate) + (days * 24 * 60 * 60 * 1000);
            var rDate = new Date(millSeconds);
            var year = rDate.getFullYear();
            var month = rDate.getMonth() + 1;
            if (month < 10) month = "0" + month;
            var date = rDate.getDate();
            if (date < 10) date = "0" + date;
            return (year + "-" + month + "-" + date);
        }
    </script>
</body>
</html>